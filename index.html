<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="color-scheme" content="light">

  <!-- iOS Home-Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Wördle">

  <!-- Icons (müssen in deinem GitHub-Repo neben index.html liegen) -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">

  <title>Wördle - Lina vs. Papa</title>

  <style>
    :root{
      --bg:#eef2f6;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 25px rgba(0,0,0,.12);
      --blue:#1f6feb;
      --blue2:#1557c0;
      --chip:#f3f4f6;
      --danger:#b91c1c;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      -webkit-text-size-adjust:100%;
      display:flex;
      justify-content:center;
      padding:24px 14px;
    }
    .wrap{width:100%; max-width:520px;}
    .card{
      background:var(--card);
      border-radius:18px;
      padding:22px;
      box-shadow:var(--shadow);
    }
    h1{
      margin:0 0 14px 0;
      font-size:32px;
      line-height:1.12;
      letter-spacing:-.02em;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px 12px;
      font-size:17px;
      margin-top:6px;
    }
    .stats .k{color:var(--text)}
    .stats .v{font-weight:800}
    .leader{
      margin:16px 0 18px;
      font-weight:900;
      font-size:20px;
    }
    h2{
      margin:0 0 10px;
      font-size:26px;
      letter-spacing:-.01em;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:16px;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-weight:800;
      padding:8px 0;
      border-bottom:1px solid var(--border);
    }
    td{
      padding:12px 0;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    td.num, th.num{ text-align:center; }
    td.num{ font-weight:800; }
    .btnrow{
      display:flex;
      justify-content:center;
      margin-top:18px;
    }
    .btn{
      background:var(--blue);
      color:#fff;
      padding:14px 22px;
      border-radius:12px;
      font-size:18px;
      font-weight:900;
      border:none;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 240px;
    }
    .btn:active{transform:translateY(1px)}
    .btn:hover{background:var(--blue2)}
    .subbar{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btn2{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 14px;
      border-radius:12px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
    }
    .btn2:active{transform:translateY(1px)}
    .btn2:hover{background:var(--chip)}
    .btn2.full{grid-column:1 / -1}
    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      margin-bottom:10px;
    }
    .error{
      display:none;
      margin-top:14px;
      padding:10px 12px;
      border-radius:12px;
      background:#fee2e2;
      color:var(--danger);
      font-weight:800;
      font-size:14px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .hidden{display:none !important}
    .centerNote{
      margin-top:14px;
      text-align:center;
      color:var(--muted);
      font-weight:800;
    }

    @media (max-width: 380px){
      h1{font-size:28px}
      h2{font-size:22px}
      .btn{min-width: 100%;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="pill" id="statusPill">Lade Daten ...</div>

    <div class="card" id="card">
      <h1>Wördle - Lina vs. Papa</h1>

      <div class="stats">
        <div class="k">Lina - Summe</div><div class="v" id="linaSum">-</div>
        <div class="k">Papa - Summe</div><div class="v" id="papaSum">-</div>
        <div class="k">Lina - Ø</div><div class="v" id="linaAvg">-</div>
        <div class="k">Papa - Ø</div><div class="v" id="papaAvg">-</div>
      </div>

      <div class="leader" id="leader">Aktuell vorne: -</div>

      <h2>Letzte 15 Einträge</h2>

      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th class="num">Lina</th>
            <th class="num">Papa</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="3">Lade ...</td></tr>
        </tbody>
      </table>

      <div class="btnrow">
        <a class="btn" id="btnForm" href="#" target="_blank" rel="noopener">+ Ergebnis eintragen</a>
      </div>

      <div class="subbar">
        <button class="btn2" id="btnPlay" type="button">Wördle spielen</button>
        <button class="btn2" id="btnRefresh" type="button">Aktualisieren</button>
        <button class="btn2 full" id="btnClose" type="button">Schließen</button>
      </div>

      <div class="error" id="err"></div>

      <div class="hint">
        Hinweis: Diese Seite lädt die Daten aus deinem veröffentlichten Google-Sheet (CSV). Wenn gar nichts kommt, ist meist der CSV-Link falsch oder der Zugriff ist nicht öffentlich.
      </div>
    </div>

    <div class="card hidden" id="closedCard">
      <h1>Geschlossen</h1>
      <div class="centerNote">Tippe auf „Öffnen“, um wieder zur Übersicht zu kommen.</div>
      <div class="btnrow">
        <button class="btn" id="btnOpen" type="button">Öffnen</button>
      </div>
    </div>
  </div>

  <script>
    // =================== HIER NUR LINKS EINTRAGEN ===================
    const CSV_URL   = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEjpKNfGDzEfrYw0QicDiJsj7KZwH_IDjaVVGhK_PpE5X-JvfwaPfXJYAkecOS21WMjeCRwBzWqiEB/pub?gid=1396043929&single=true&output=csv";
    const FORM_URL  = "https://docs.google.com/forms/d/e/1FAIpQLScaYkNl3Pw8i6HFT6vSQ8sBioqNHiuN87ha8wQp08rvTdk-ng/viewform?";
    const WORDLE_URL = "https://www.xn--wrdle-jua.de/";
    // ================================================================

    const $ = (id) => document.getElementById(id);

    $("btnForm").href = FORM_URL;
    $("btnPlay").addEventListener("click", () => window.open(WORDLE_URL, "_blank", "noopener"));
    $("btnRefresh").addEventListener("click", () => loadAll(true));
    $("btnClose").addEventListener("click", () => {
      $("card").classList.add("hidden");
      $("closedCard").classList.remove("hidden");
    });
    $("btnOpen").addEventListener("click", () => {
      $("closedCard").classList.add("hidden");
      $("card").classList.remove("hidden");
    });

    function showError(msg){
      const el = $("err");
      el.style.display = "block";
      el.textContent = msg;
    }
    function clearError(){
      const el = $("err");
      el.style.display = "none";
      el.textContent = "";
    }

    // CSV parser (handles quotes)
    function parseCSV(text){
      const rows = [];
      let row = [], cur = "", inQuotes = false;
      for (let i=0;i<text.length;i++){
        const c = text[i];
        if (c === '"'){
          if (inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (c === ',' && !inQuotes){
          row.push(cur); cur = "";
        } else if ((c === '\n' || c === '\r') && !inQuotes){
          if (c === '\r' && text[i+1] === '\n') i++;
          row.push(cur); cur = "";
          if (row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);
          row = [];
        } else {
          cur += c;
        }
      }
      if (cur.length || row.length){
        row.push(cur);
        if (row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);
      }
      return rows;
    }

    function norm(s){ return (s ?? "").toString().trim(); }
    function lower(s){ return norm(s).toLowerCase(); }

    function toNumber(x){
      const t = norm(x).replace(",", ".");
      const n = Number(t);
      return Number.isFinite(n) ? n : null;
    }

    function fmtAvg(n){
      if (n === null || n === undefined) return "-";
      const s = (Math.round(n*10)/10).toFixed(1);
      return s.endsWith(".0") ? s.slice(0,-2) : s;
    }

    function withNoCache(url){
      const u = new URL(url);
      u.searchParams.set("_", Date.now().toString());
      return u.toString();
    }

    function detectColumns(header){
      const h = header.map(lower);
      const idx = (pred) => h.findIndex(pred);

      let dateIdx = idx(x => x.includes("datum"));
      let scoreIdx = idx(x => x.includes("ergebnis") || x.includes("punkte") || x.includes("score") || x.includes("versuch") || x.includes("guess"));
      let whoIdx = idx(x => x.includes("spieler") || x.includes("name") || x.includes("person") || x.includes("wer"));

      // fallback: A Zeitstempel, B Datum, C Zahl, D Spieler
      if (dateIdx === -1 && header.length >= 2) dateIdx = 1;
      if (scoreIdx === -1 && header.length >= 3) scoreIdx = 2;
      if (whoIdx === -1 && header.length >= 4) whoIdx = 3;

      let tsIdx = idx(x => x.includes("zeit") || x.includes("timestamp"));
      if (tsIdx === -1) tsIdx = 0;

      return { tsIdx, dateIdx, scoreIdx, whoIdx };
    }

    function buildModel(csvRows){
      if (!csvRows.length) return null;

      const header = csvRows[0];
      const { tsIdx, dateIdx, scoreIdx, whoIdx } = detectColumns(header);

      const byDate = new Map();

      for (let i=1; i<csvRows.length; i++){
        const r = csvRows[i];
        const date = norm(r[dateIdx]);
        if (!date) continue;

        const whoRaw = lower(r[whoIdx]);
        const score = toNumber(r[scoreIdx]);
        if (score === null) continue;

        let who = null;
        if (whoRaw.includes("lina")) who = "lina";
        else if (whoRaw.includes("papa")) who = "papa";
        else continue;

        const ts = norm(r[tsIdx]) || String(i);

        if (!byDate.has(date)) byDate.set(date, { date, lina: null, papa: null, tsLina: "", tsPapa: "" });

        const obj = byDate.get(date);
        if (who === "lina"){
          if (!obj.tsLina || ts >= obj.tsLina){ obj.lina = score; obj.tsLina = ts; }
        } else {
          if (!obj.tsPapa || ts >= obj.tsPapa){ obj.papa = score; obj.tsPapa = ts; }
        }
      }

      const parseDE = (d) => {
        const m = /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/.exec(d.trim());
        if (!m) return null;
        const day = Number(m[1]), mon = Number(m[2]), yr = Number(m[3]);
        const dt = new Date(yr, mon-1, day);
        return isNaN(dt.getTime()) ? null : dt.getTime();
      };

      const rows = Array.from(byDate.values());
      rows.sort((a,b) => {
        const ta = parseDE(a.date);
        const tb = parseDE(b.date);
        if (ta !== null && tb !== null) return tb - ta;
        return (b.date || "").localeCompare(a.date || "");
      });

      const last15 = rows.slice(0,15);

      let linaSum = 0, papaSum = 0, linaCnt = 0, papaCnt = 0;
      for (const d of rows){
        if (typeof d.lina === "number"){ linaSum += d.lina; linaCnt++; }
        if (typeof d.papa === "number"){ papaSum += d.papa; papaCnt++; }
      }

      const linaAvg = linaCnt ? (linaSum / linaCnt) : null;
      const papaAvg = papaCnt ? (papaSum / papaCnt) : null;

      let leader = "-";
      if (linaAvg !== null && papaAvg !== null){
        if (Math.abs(linaAvg - papaAvg) < 1e-9) leader = "Gleichstand";
        else leader = (linaAvg < papaAvg) ? "Lina führt" : "Papa führt";
      } else if (linaAvg !== null && papaAvg === null) leader = "Lina führt";
      else if (papaAvg !== null && linaAvg === null) leader = "Papa führt";

      return {
        linaSum: linaCnt ? String(linaSum) : "-",
        papaSum: papaCnt ? String(papaSum) : "-",
        linaAvg: fmtAvg(linaAvg),
        papaAvg: fmtAvg(papaAvg),
        leader,
        last15
      };
    }

    function escapeHtml(s){
      return (s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function render(model){
      $("linaSum").textContent = model.linaSum;
      $("papaSum").textContent = model.papaSum;
      $("linaAvg").textContent = model.linaAvg;
      $("papaAvg").textContent = model.papaAvg;
      $("leader").textContent = "Aktuell vorne: " + model.leader;

      const tbody = $("rows");
      tbody.innerHTML = "";

      if (!model.last15.length){
        tbody.innerHTML = '<tr><td colspan="3">Noch keine Einträge</td></tr>';
        return;
      }

      for (const r of model.last15){
        const lina = (typeof r.lina === "number") ? r.lina : "";
        const papa = (typeof r.papa === "number") ? r.papa : "";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(r.date)}</td>
          <td class="num">${escapeHtml(String(lina))}</td>
          <td class="num">${escapeHtml(String(papa))}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function loadAll(force){
      clearError();
      $("statusPill").textContent = force ? "Aktualisiere ..." : "Lade Daten ...";

      try{
        const res = await fetch(withNoCache(CSV_URL), { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const csv = parseCSV(text);

        const model = buildModel(csv);
        if (!model) throw new Error("Keine Daten gefunden.");

        render(model);
        $("statusPill").textContent = "Aktuell";
      } catch (e){
        $("statusPill").textContent = "Fehler";
        showError(
          "Konnte Daten nicht laden.\n\n" +
          "Wenn du den CSV-Link gerade erst veröffentlicht hast: 1 Minute warten und nochmal „Aktualisieren“.\n\n" +
          "Technischer Hinweis: " + (e?.message || e)
        );
        $("rows").innerHTML = '<tr><td colspan="3">Keine Daten geladen</td></tr>';
        $("linaSum").textContent = "-";
        $("papaSum").textContent = "-";
        $("linaAvg").textContent = "-";
        $("papaAvg").textContent = "-";
        $("leader").textContent = "Aktuell vorne: -";
      }
    }

    loadAll(false);
  </script>
</body>
</html>
