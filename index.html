<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <title>Wördle - Lina vs. Papa</title>

  <!-- iOS / Home-Screen Icon (muss als Datei im gleichen Ordner liegen: icon.png) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Wördle">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">

  <style>
    :root{
      --bg:#eef2f6;
      --card:#ffffff;
      --shadow: 0 10px 25px rgba(0,0,0,.12);
      --blue:#1f6feb;
      --gray:#6b7280;
      --line:#e5e7eb;
      --text:#111827;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:24px 14px;
    }
    .wrap{
      width:100%;
      max-width:520px;
    }
    .card{
      background:var(--card);
      width:100%;
      border-radius:18px;
      padding:22px;
      box-shadow:var(--shadow);
    }
    h1{
      margin:0 0 12px 0;
      font-size:30px;
      line-height:1.1;
      font-weight:900;
      letter-spacing:-.2px;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 12px;
      font-size:16px;
      margin-top:10px;
    }
    .stats b{ font-weight:900; }
    .leader{
      margin:14px 0 12px;
      font-weight:900;
      font-size:18px;
    }
    h2{
      margin:16px 0 10px;
      font-size:26px;
      font-weight:900;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:15px;
    }
    th{
      text-align:left;
      color:var(--gray);
      font-weight:800;
      padding:8px 0 6px;
    }
    td{
      padding:12px 0;
      border-top:1px solid var(--line);
      vertical-align:middle;
    }
    td.num, th.num{
      text-align:center;
      font-weight:900;
      width:72px;
    }

    .btnbar{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:16px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      background:var(--blue);
      color:#fff;
      padding:14px 18px;
      border-radius:12px;
      font-size:18px;
      font-weight:900;
      text-decoration:none;
      border:0;
      cursor:pointer;
      min-width:220px;
    }
    .btn.secondary{
      background:#ffffff;
      color:var(--text);
      border:1px solid var(--line);
      min-width:160px;
    }
    .btn.small{
      min-width:160px;
      padding:12px 14px;
      font-size:16px;
    }
    .subbar{
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .hint{
      margin-top:10px;
      font-size:13px;
      color:var(--gray);
      line-height:1.35;
      word-break:break-word;
    }
    .error{
      margin-top:10px;
      font-size:14px;
      color:#b91c1c;
      font-weight:700;
      display:none;
    }

    /* Mobile: Card soll "groß" wirken */
    @media (max-width: 420px){
      body{ padding:14px 10px; }
      .card{ padding:18px; }
      h1{ font-size:28px; }
      h2{ font-size:24px; }
      .btn{ width:100%; min-width:0; }
      .btn.secondary, .btn.small{ width:calc(50% - 5px); min-width:0; }
      .subbar .btn.small{ width:calc(50% - 5px); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="card">
      <h1>Wördle - Lina vs. Papa</h1>

      <div class="stats" aria-label="Statistiken">
        <div>Lina - Summe</div><div><b id="linaSum">-</b></div>
        <div>Papa - Summe</div><div><b id="papaSum">-</b></div>
        <div>Lina - Ø</div><div><b id="linaAvg">-</b></div>
        <div>Papa - Ø</div><div><b id="papaAvg">-</b></div>
      </div>

      <div class="leader" id="leader">Aktuell vorne: -</div>

      <h2>Letzte 15 Einträge</h2>

      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th class="num">Lina</th>
            <th class="num">Papa</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="3">Lade Daten ...</td></tr>
        </tbody>
      </table>

      <div class="btnbar">
        <a class="btn" id="btnForm" href="#" target="_blank" rel="noopener">+ Ergebnis eintragen</a>
      </div>

      <div class="subbar">
        <button class="btn secondary small" id="btnPlay" type="button">Wördle spielen</button>
        <button class="btn secondary small" id="btnRefresh" type="button">Aktualisieren</button>
        <button class="btn secondary small" id="btnClose" type="button">Schließen</button>
      </div>

      <div class="error" id="err"></div>
      <div class="hint">
        <b>Hinweis:</b> Diese Seite lädt die Daten per <b>API_URL</b>. Wenn du nur eine Überschrift siehst, ist meist der API-Link falsch oder er liefert kein JSON (oder er ist nicht öffentlich).
      </div>
    </div>
  </div>

  <script>
    // ========= HIER DEINE LINKS EINTRAGEN =========
    // 1) Apps Script JSON-Endpoint (öffentlich). Beispiel: https://script.google.com/macros/s/XXXX/exec
    const API_URL  = "PASTE_DEIN_APPS_SCRIPT_EXEC_LINK_HIER";

    // 2) Google-Formular "viewform" Link:
    const FORM_URL = "PASTE_DEIN_VIEWFORM_LINK_HIER";

    // 3) Wördle (deutsche Seite)
    const WORDLE_URL = "https://www.xn--wrdle-jua.de/";
    // =============================================

    const $ = (id) => document.getElementById(id);

    function fmt(n){
      if (n === null || n === undefined || n === "") return "-";
      const num = Number(n);
      if (Number.isNaN(num)) return String(n);
      const s = (Math.round(num * 10) / 10).toFixed(1);
      return s.endsWith(".0") ? s.slice(0, -2) : s;
    }

    function setText(id, val){ $(id).textContent = val; }

    function showError(msg){
      const el = $("err");
      el.style.display = "block";
      el.textContent = msg;
    }
    function hideError(){
      const el = $("err");
      el.style.display = "none";
      el.textContent = "";
    }

    function normalizeData(d){
      const out = {};
      out.linaSum = d.linaSum ?? d.LinaSum ?? d.lina_sum ?? d.sumLina ?? d.linaTotal ?? 0;
      out.papaSum = d.papaSum ?? d.PapaSum ?? d.papa_sum ?? d.sumPapa ?? d.papaTotal ?? 0;
      out.linaAvg = d.linaAvg ?? d.LinaAvg ?? d.lina_avg ?? d.avgLina ?? d.linaMean ?? 0;
      out.papaAvg = d.papaAvg ?? d.PapaAvg ?? d.papa_avg ?? d.avgPapa ?? d.papaMean ?? 0;
      out.leader  = d.leader  ?? d.Leader  ?? d.fuehrt ?? "";

      out.rows = Array.isArray(d.rows) ? d.rows : (Array.isArray(d.latest) ? d.latest : []);
      out.rows = out.rows.map(r => ({
        date: r.date ?? r.datum ?? r.day ?? "",
        lina: r.lina ?? r.Lina ?? r.l ?? "",
        papa: r.papa ?? r.Papa ?? r.p ?? ""
      }));

      if (!out.leader){
        const la = Number(out.linaAvg), pa = Number(out.papaAvg);
        if (!Number.isNaN(la) && !Number.isNaN(pa)){
          if (la < pa) out.leader = "Lina führt";
          else if (pa < la) out.leader = "Papa führt";
          else out.leader = "Gleichstand";
        } else {
          out.leader = "-";
        }
      }
      return out;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function load(){
      hideError();

      $("btnForm").href = (FORM_URL && !FORM_URL.includes("PASTE_")) ? FORM_URL : "#";

      if (!API_URL || API_URL.includes("PASTE_")) {
        $("rows").innerHTML = '<tr><td colspan="3">Bitte API_URL oben im Code eintragen.</td></tr>';
        showError("API_URL fehlt. Bitte im Code oben deinen Apps-Script /exec Link eintragen.");
        return;
      }

      try{
        $("rows").innerHTML = '<tr><td colspan="3">Lade Daten ...</td></tr>';

        const url = new URL(API_URL);
        url.searchParams.set("format","json");
        url.searchParams.set("_", Date.now().toString()); // Cache-Buster

        const res = await fetch(url.toString(), { cache: "no-store" });
        const text = await res.text();

        let data;
        try{
          data = JSON.parse(text);
        }catch(e){
          throw new Error("Keine JSON-Antwort erhalten (bekommen: " + text.slice(0, 120) + ")");
        }

        if (data && data.ok === false && data.error){
          throw new Error(data.error);
        }

        const d = normalizeData(data);

        setText("linaSum", fmt(d.linaSum));
        setText("papaSum", fmt(d.papaSum));
        setText("linaAvg", fmt(d.linaAvg));
        setText("papaAvg", fmt(d.papaAvg));
        $("leader").textContent = "Aktuell vorne: " + d.leader;

        if (!d.rows.length){
          $("rows").innerHTML = '<tr><td colspan="3">Noch keine Einträge</td></tr>';
        } else {
          $("rows").innerHTML = d.rows.slice(0,15).map(r => `
            <tr>
              <td>${escapeHtml(r.date)}</td>
              <td class="num">${escapeHtml(String(r.lina ?? ""))}</td>
              <td class="num">${escapeHtml(String(r.papa ?? ""))}</td>
            </tr>
          `).join("");
        }

      }catch(err){
        $("rows").innerHTML = '<tr><td colspan="3">Keine Daten geladen</td></tr>';
        showError("Fehler beim Laden: " + (err?.message || err));
      }
    }

    $("btnPlay").addEventListener("click", () => window.open(WORDLE_URL, "_blank", "noopener"));
    $("btnRefresh").addEventListener("click", () => load());
    $("btnClose").addEventListener("click", () => { $("card").style.display = "none"; });

    load();
  </script>
</body>
</html>
