<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wördle - Lina vs. Papa</title>
  <style>
    :root{
      --bg:#ffffff;--text:#111827;--muted:#6b7280;--card:#f9fafb;--border:#e5e7eb;
      --accent:#f59e0b;--danger:#dc2626;--ok:#16a34a;
      --shadow:0 8px 24px rgba(17,24,39,.08);--radius:14px;
      --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--text);}
    header{padding:16px;border-bottom:1px solid var(--border);}
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    h1{margin:0;font-size:20px;}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);}
    .form{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
    @media (max-width:520px){.form{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input,select,button{width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);font-family:var(--font);}
    button{font-weight:800;cursor:pointer;white-space:nowrap;}
    .btnPrimary{background:var(--accent);border:0;}
    .btnCloud{background:#fff;border:1px solid rgba(245,158,11,.55);}
    .btnSecondary{background:#fff;}
    .btnDanger{background:#fff;border:1px solid rgba(220,38,38,.35);color:var(--danger);}

    /* FIX: Buttons überlappen NIE mehr – flex-wrap statt grid */
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .actions button{flex:1 1 240px;min-width:220px;}
    @media (max-width:520px){.actions button{min-width:0;flex-basis:100%;}}

    .status{font-size:12px;color:var(--muted);margin-top:10px;}
    .status .bad{color:var(--danger);font-weight:800;}
    .status .ok{color:var(--ok);font-weight:800;}

    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
    th,td{border-bottom:1px solid var(--border);padding:8px;font-size:14px;}
    th{text-align:left;color:var(--muted);font-size:12px;background:#fafafa;}
    tr:last-child td{border-bottom:0}
    .right{text-align:right;}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;}
    code{background:#fff;border:1px solid var(--border);padding:2px 6px;border-radius:8px;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Wördle - Lina vs. Papa</h1>
    <div class="subtitle">1-6 Versuche, 7 = nicht geschafft - Geräteübergreifend per Google Sheet</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Eintrag</h2>

      <div class="form">
        <div>
          <label for="date">Datum</label>
          <input type="date" id="date" />
        </div>
        <div>
          <label for="player">Spieler</label>
          <select id="player">
            <option>Lina</option>
            <option>Papa</option>
          </select>
        </div>
        <div>
          <label for="score">Ergebnis</label>
          <select id="score">
            <option>1</option><option>2</option><option>3</option>
            <option>4</option><option>5</option><option>6</option>
            <option>7</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button class="btnPrimary" id="save">Speichern</button>
        <button class="btnCloud" id="sync">Cloud synchronisieren</button>
        <button class="btnSecondary" id="export">Export (CSV)</button>
        <button class="btnDanger" id="reset">Alles löschen</button>
      </div>

      <div class="status" id="cloudStatus">Cloud: —</div>
      <div class="hint">
        Hinweis: Cloud-POST wird ohne CORS-Preflight gesendet (iPad/Safari-kompatibel).
      </div>
    </section>

    <section class="card">
      <h2>Übersicht</h2>
      <table>
        <thead>
          <tr><th>Datum</th><th class="right">Lina</th><th class="right">Papa</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </section>
  </div>
</main>

<script>
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbzsHem6Pjjy5ti6KWTVAsMZxdA1M1nEqUOmSVC7ygl7jxB96doR04kUCu1HWBCPFlgQHw/exec";
const CLOUD_KEY = "woerdle2025";
const LS_KEY = "woerdle_entries_v2";

const $ = id => document.getElementById(id);
const dateEl = $("date");
const playerEl = $("player");
const scoreEl = $("score");
const rowsEl = $("rows");
const cloudStatus = $("cloudStatus");

dateEl.valueAsDate = new Date();

let entries = load();

$("save").onclick = async () => {
  const e = {date: dateEl.value, player: playerEl.value, score: Number(scoreEl.value)};
  upsert(e);
  render();
  try {
    await post(e);
    setStatus(true, "verbunden");
  } catch(err) {
    setStatus(false, humanErr(err));
  }
};

$("sync").onclick = async () => {
  try {
    const list = await get();
    entries = list;
    persist();
    render();
    setStatus(true, "verbunden");
  } catch(err) {
    setStatus(false, humanErr(err));
  }
};

$("export").onclick = () => {
  const rows = [["date","player","score"]];
  const sorted = [...entries].sort((a,b)=>a.date.localeCompare(b.date) || a.player.localeCompare(b.player));
  for(const e of sorted) rows.push([e.date, e.player, String(e.score)]);
  const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "woerdle_lina_papa.csv";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

$("reset").onclick = () => {
  if(confirm("Lokale Daten löschen? (Cloud bleibt unverändert)")) {
    entries = [];
    persist();
    render();
    setStatus(null, "bereit");
  }
};

function setStatus(ok, msg){
  if(ok === true) cloudStatus.innerHTML = 'Cloud: <span class="ok">'+escapeHtml(msg)+'</span>';
  else if(ok === false) cloudStatus.innerHTML = 'Cloud: <span class="bad">Fehler</span> - ' + escapeHtml(msg);
  else cloudStatus.textContent = "Cloud: " + msg;
}

function upsert(e){
  const i = entries.findIndex(x=>x.date===e.date && x.player===e.player);
  if(i>=0) entries[i]=e; else entries.push(e);
  persist();
}

function render(){
  rowsEl.innerHTML="";
  const map = {};
  entries.forEach(e=>{ map[e.date] = map[e.date]||{}; map[e.date][e.player]=e.score; });
  Object.keys(map).sort().reverse().forEach(d=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(d)}</td><td class="right">${escapeHtml(map[d].Lina ?? "")}</td><td class="right">${escapeHtml(map[d].Papa ?? "")}</td>`;
    rowsEl.appendChild(tr);
  });
}

function persist(){ localStorage.setItem(LS_KEY, JSON.stringify(entries)); }
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } }

async function get(){
  const url = CLOUD_URL + "?action=list&key=" + encodeURIComponent(CLOUD_KEY) + "&_=" + Date.now();
  const r = await fetch(url, { method:"GET" });
  const text = await r.text();
  if(!r.ok) throw new Error("HTTP " + r.status + " " + text.slice(0,160));
  const j = JSON.parse(text);
  if(!j.ok) throw new Error(j.error || "cloud_error");
  return j.entries||[];
}

/* IMPORTANT: text/plain => vermeidet CORS Preflight (iPad/Safari) */
async function post(e){
  const payload = {action:"upsert", key:CLOUD_KEY, entry:e};
  const r = await fetch(CLOUD_URL, {
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(payload)
  });
  const text = await r.text();
  if(!r.ok) throw new Error("HTTP " + r.status + " " + text.slice(0,160));
  let j = null;
  try { j = JSON.parse(text); } catch(_){
    // Manche Deployments liefern leere Antwort – dann ist ok
    return true;
  }
  if(j && j.ok===false) throw new Error(j.error || "cloud_error");
  return true;
}

function humanErr(err){
  const s = String(err && err.message ? err.message : err);
  if(s.includes("Failed to fetch")) return "Netzwerk/CORS (Safari Cache?)";
  if(s.includes("HTTP 401")) return "401 unauthorized (Key/Zugriff)";
  if(s.includes("HTTP 403")) return "403 forbidden (Deploy/Rechte)";
  if(s.toLowerCase().includes("unauthorized")) return "unauthorized (Key stimmt nicht)";
  return s.slice(0,160);
}

function escapeHtml(v){
  return String(v).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}

render();
setStatus(null, "bereit");
</script>
</body>
</html>
