<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wördle - Lina vs. Papa</title>
  <style>
    :root{
      /* "Wördle"-Farben (grün/gelb/weiß) */
      --green:#6aaa64;
      --yellow:#c9b458;
      --bg:#fffdf4;         /* warmes off-white */
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 12px 28px rgba(0,0,0,.10);
      --radius:18px;
      --font:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(201,180,88,.22), transparent 60%),
        radial-gradient(800px 500px at 100% 20%, rgba(106,170,100,.18), transparent 55%),
        var(--bg);
    }
    .page{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:42px 14px;
    }
    .wrap{width:min(520px, 100%)}
    .toplabel{
      text-align:center;
      color:var(--muted);
      font-size:13px;
      font-weight:700;
      margin:0 0 10px 0;
      letter-spacing:.2px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 16px 22px;
      position:relative;
      overflow:hidden;
    }
    /* dezente Farb-Kante oben */
    .card::before{
      content:"";
      position:absolute;
      left:0; top:0; right:0;
      height:10px;
      background:linear-gradient(90deg, var(--green), var(--yellow));
    }

    h1{
      margin:0 0 14px 0;
      padding-top:6px;
      font-size:34px;
      line-height:1.05;
      letter-spacing:-.5px;
    }

    .stats{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px 16px;
      margin-bottom:10px;
    }
    .stats .k{color:var(--text);font-size:16px}
    .stats .v{font-weight:800;font-size:16px}

    .lead{
      margin:10px 0 18px 0;
      font-size:18px;
      font-weight:900;
      display:inline-block;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid rgba(201,180,88,.35);
      background:rgba(201,180,88,.14);
    }

    h2{
      margin:0 0 10px 0;
      font-size:26px;
      letter-spacing:-.2px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-bottom:16px;
    }
    th,td{
      padding:10px 4px;
      border-bottom:1px solid var(--line);
      font-size:16px;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-size:14px;
      font-weight:800;
    }
    th.num, td.num{ text-align:center; width:90px; }
    td.num{ font-weight:900; }

    .btn{
      width:100%;
      border:none;
      border-radius:12px;
      padding:12px 14px;
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      transition:transform .05s ease, filter .15s ease;
      text-align:center;
      text-decoration:none;
      display:inline-block;
    }
    .btn:active{ transform:translateY(1px); }

    .btn.primary{
      background:var(--green);
      color:#fff;
    }
    .btn.primary:hover{ filter:brightness(.95); }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .btn.ghost{
      background:#fff;
      color:var(--text);
      border:2px solid rgba(201,180,88,.55);
      font-weight:900;
    }
    .btn.ghost:hover{ filter:brightness(.98); }

    /* kleiner Korrektur-Link */
    .editlink{
      text-align:center;
      margin-top:10px;
    }
    .editlink a{
      font-size:11px;
      color:#8b8f99;
      text-decoration:none;
    }
    .editlink a:hover{ text-decoration:underline; color:#111827; }

    .error{
      display:none;
      margin:0 0 10px 0;
      padding:10px 12px;
      border-radius:12px;
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      font-size:13px;
    }

    @media (max-width:420px){
      h1{font-size:30px}
      .row{grid-template-columns:1fr}
      th.num, td.num{width:78px}
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="wrap">
      <div class="toplabel">Aktuell</div>

      <div class="card">
        <h1>Wördle - Lina vs. Papa</h1>

        <div class="error" id="errorBox"></div>

        <div class="stats" aria-label="Statistik">
          <div class="k">Lina - Summe</div><div class="v" id="linaSum">-</div>
          <div class="k">Papa - Summe</div><div class="v" id="papaSum">-</div>
          <div class="k">Lina - Ø</div><div class="v" id="linaAvg">-</div>
          <div class="k">Papa - Ø</div><div class="v" id="papaAvg">-</div>
        </div>

        <div class="lead" id="leader">Aktuell vorne: -</div>

        <h2>Letzte 15 Einträge</h2>
        <table aria-label="Letzte Einträge">
          <thead>
            <tr>
              <th>Datum</th>
              <th class="num">Lina</th>
              <th class="num">Papa</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>

        <a class="btn primary" id="btnEntry" href="#" target="_blank" rel="noopener">+ Ergebnis eintragen</a>

        <div class="row">
          <a class="btn ghost" id="btnPlay" href="#" target="_blank" rel="noopener">Wördle spielen</a>
          <button class="btn ghost" id="btnReload" type="button">Aktualisieren</button>
        </div>

        <div class="editlink">
          <a id="editLink" href="#" target="_blank" rel="noopener">Daten korrigieren</a>
        </div>
      </div>
    </div>
  </div>

<script>
/*** KONFIG ***/
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEjpKNfGDzEfrYw0QicDiJsj7KZwH_IDjaVVGhK_PpE5X-JvfwaPfXJYAkecOS21WMjeCRwBzWqiEB/pub?gid=1396043929&single=true&output=csv";
const SHEET_EDIT_URL = "https://docs.google.com/spreadsheets/d/1ytod7wRvaxWMS5-afZ2YBWe9h5l2ms6GSqqJSILhSE0/edit?usp=drivesdk";

// Optional: Wenn du einen Google-Form Link zum Eintragen hast, hier einsetzen.
// Sonst zeigt "+ Ergebnis eintragen" einfach auf das Sheet (praktisch).
const ENTRY_FORM_URL = "";
const WORDLE_URL = "https://www.nytimes.com/games/wordle/index.html";

/*** HELPERS ***/
const $ = (id)=>document.getElementById(id);

function showError(msg){
  const el = $("errorBox");
  el.style.display = "block";
  el.textContent = msg;
}
function hideError(){
  const el = $("errorBox");
  el.style.display = "none";
  el.textContent = "";
}

// CSV parser (quotes + commas)
function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for (let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if (ch === '"' && inQ && nx === '"'){ cur += '"'; i++; continue; }
    if (ch === '"'){ inQ = !inQ; continue; }
    if (ch === ',' && !inQ){ row.push(cur.trim()); cur=""; continue; }
    if ((ch === '\n' || ch === '\r') && !inQ){
      if (cur.length || row.length){ row.push(cur.trim()); rows.push(row); }
      row=[]; cur="";
      if (ch === '\r' && nx === '\n') i++;
      continue;
    }
    cur += ch;
  }
  if (cur.length || row.length){ row.push(cur.trim()); rows.push(row); }
  return rows.filter(r => r.some(c => (c??"").trim() !== ""));
}

function norm(s){ return (s??"").toString().trim().toLowerCase(); }

function parseDateDMY(s){
  if (!s) return null;
  const m = s.trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if (!m) return null;
  const d = new Date(Number(m[3]), Number(m[2])-1, Number(m[1]));
  return isNaN(d.getTime()) ? null : d;
}

// timestamp in CSV can be "22.12.2025 16:16:56"
function parseTimestamp(s){
  if (!s) return 0;
  const t = s.trim();
  const iso = Date.parse(t);
  if (!isNaN(iso)) return iso;

  const m = t.match(/^(\d{2})\.(\d{2})\.(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
  if (m){
    const d = new Date(Number(m[3]), Number(m[2])-1, Number(m[1]), Number(m[4]), Number(m[5]), Number(m[6]||"0"));
    return d.getTime();
  }
  return 0;
}

function fmtAvg(x){
  if (!isFinite(x) || x<=0) return "-";
  const s = (Math.round(x*10)/10).toString();
  return s.endsWith(".0") ? s.slice(0,-2) : s;
}

async function load(){
  hideError();

  $("editLink").href = SHEET_EDIT_URL;
  $("btnPlay").href = WORDLE_URL;

  $("btnEntry").href = (ENTRY_FORM_URL && ENTRY_FORM_URL.startsWith("https://docs.google.com/forms/"))
    ? ENTRY_FORM_URL
    : SHEET_EDIT_URL;

  try{
    const res = await fetch(CSV_URL, {cache:"no-store"});
    if(!res.ok) throw new Error("CSV konnte nicht geladen werden (HTTP "+res.status+").");
    const text = await res.text();
    const data = parseCSV(text);
    if(!data.length) throw new Error("CSV ist leer.");

    const headers = data[0].map(h=>h.trim());
    const rows = data.slice(1);

    const idxTs   = headers.findIndex(h => norm(h).includes("zeitstempel") || norm(h).includes("timestamp"));
    const idxDate = headers.findIndex(h => norm(h).includes("datum des wördle") || norm(h).includes("datum des w") || norm(h)==="datum" || norm(h).includes("datum"));
    const idxTry  = headers.findIndex(h => norm(h).includes("wie viele versuche") || norm(h).includes("versuche"));
    const idxName = headers.findIndex(h => norm(h).includes("name des spielers") || norm(h).includes("spieler") || norm(h).includes("name"));

    if (idxDate < 0 || idxTry < 0 || idxName < 0){
      throw new Error("Spalten nicht erkannt. Bitte Header im Sheet prüfen (Datum / Versuche / Name).");
    }

    const entries = [];
    for (const r of rows){
      const puzzleDate = r[idxDate];
      const triesRaw = r[idxTry];
      const name = r[idxName];

      const tries = Number((triesRaw??"").toString().replace(",", "."));
      const d = parseDateDMY(puzzleDate);
      if (!d || !isFinite(tries)) continue;

      const ts = idxTs >= 0 ? parseTimestamp(r[idxTs]) : 0;

      entries.push({
        dateStr: puzzleDate.trim(),
        date: d.getTime(),
        tries,
        name: (name??"").toString().trim(),
        ts
      });
    }

    const byKey = new Map(); // date|name -> last by timestamp
    for (const e of entries){
      const key = e.dateStr + "|" + e.name.toLowerCase();
      const prev = byKey.get(key);
      if (!prev || e.ts >= prev.ts) byKey.set(key, e);
    }

    const byDate = new Map(); // dateStr -> {date, lina, papa}
    for (const e of byKey.values()){
      const d = byDate.get(e.dateStr) || {date:e.date, lina:null, papa:null};
      if (e.name.toLowerCase() === "lina") d.lina = e.tries;
      if (e.name.toLowerCase() === "papa") d.papa = e.tries;
      byDate.set(e.dateStr, d);
    }

    const last = Array.from(byDate.entries())
      .map(([dateStr, obj])=>({dateStr, ...obj}))
      .sort((a,b)=>b.date - a.date)
      .slice(0,15);

    const tbody = $("rows");
    tbody.innerHTML = "";
    for (const r of last){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.dateStr}</td>
        <td class="num">${r.lina ?? ""}</td>
        <td class="num">${r.papa ?? ""}</td>
      `;
      tbody.appendChild(tr);
    }

    function calc(player){
      let sum=0, cnt=0;
      for (const r of byDate.values()){
        const v = player==="lina" ? r.lina : r.papa;
        if (v!=null && isFinite(v)){ sum += v; cnt += 1; }
      }
      return {sum, cnt, avg: cnt? sum/cnt : 0};
    }
    const lina = calc("lina");
    const papa = calc("papa");

    $("linaSum").textContent = lina.cnt ? lina.sum : "-";
    $("papaSum").textContent = papa.cnt ? papa.sum : "-";
    $("linaAvg").textContent = lina.cnt ? fmtAvg(lina.avg) : "-";
    $("papaAvg").textContent = papa.cnt ? fmtAvg(papa.avg) : "-";

    let leader = "-";
    if (lina.cnt && papa.cnt){
      if (papa.avg < lina.avg) leader = "Papa führt";
      else if (lina.avg < papa.avg) leader = "Lina führt";
      else if (papa.sum < lina.sum) leader = "Papa führt";
      else if (lina.sum < papa.sum) leader = "Lina führt";
      else leader = "Gleichstand";
    } else if (lina.cnt && !papa.cnt){
      leader = "Lina führt";
    } else if (papa.cnt && !lina.cnt){
      leader = "Papa führt";
    }
    $("leader").textContent = "Aktuell vorne: " + leader;

  }catch(err){
    showError("Fehler beim Laden: " + (err?.message || err));
    $("rows").innerHTML = "";
    $("linaSum").textContent = "-";
    $("papaSum").textContent = "-";
    $("linaAvg").textContent = "-";
    $("papaAvg").textContent = "-";
    $("leader").textContent = "Aktuell vorne: -";
  }
}

$("btnReload").addEventListener("click", load);
load();
</script>
</body>
</html>
