<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wördle - Lina vs. Papa</title>
  <meta name="theme-color" content="#6da56a" />
  <style>
    :root{
      --bg:#efe7d6;
      --card:#ffffff;
      --ink:#0f1a2a;
      --muted:#6b7280;
      --accent:#6da56a;
      --line:#e5e7eb;
      --pill:#efe7d6;
      --shadow: 0 14px 40px rgba(0,0,0,.12);
      --radius: 22px;
      --pad: 22px;
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:linear-gradient(180deg, #e7dfce 0%, #efe7d6 35%, #efe7d6 100%);
      color:var(--ink);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px 14px 60px;
    }
    .wrap{width:min(520px, 100%);}
    .topbar{
      text-align:center;
      font-weight:700;
      color:#4b5563;
      letter-spacing:.2px;
      margin-bottom:10px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.04);
    }
    .cap{
      height:10px;
      background:linear-gradient(90deg, var(--accent) 0%, #c4b14b 100%);
    }
    .inner{padding:var(--pad);}
    h1{
      margin:0 0 14px;
      font-size:40px;
      line-height:1.05;
      letter-spacing:-.6px;
    }
    .stats{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px 14px;
      font-size:22px;
      line-height:1.15;
      margin:12px 0 10px;
    }
    .stats .label{font-weight:650;}
    .stats .val{font-weight:800; text-align:right;}
    .divider{height:1px;background:var(--line); margin:14px 0;}
    .leader{
      background:#f3ecd9;
      border:2px solid rgba(196,177,75,.35);
      border-radius:14px;
      padding:12px 14px;
      font-size:26px;
      font-weight:900;
      letter-spacing:-.3px;
      margin:10px 0 14px;
    }
    h2{
      margin:10px 0 10px;
      font-size:40px;
      letter-spacing:-.8px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:20px;
      font-variant-numeric: tabular-nums;
    }
    thead th{
      text-align:left;
      color:var(--muted);
      font-weight:800;
      padding:10px 0 10px;
      border-bottom:2px solid var(--line);
    }
    tbody td{
      padding:14px 0;
      border-bottom:1px solid var(--line);
      font-weight:800;
    }
    th.num, td.num{text-align:right;font-weight:600;font-size:16px;font-variant-numeric:tabular-nums;}
    .btn{
      width:100%;
      border:0;
      border-radius:16px;
      padding:16px 18px;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      line-height:1;
      text-decoration:none;
    }
    .btn.primary{background:var(--accent); color:#fff;}
    .btn.secondary{
      background:#fff;
      border:3px solid rgba(196,177,75,.40);
      color:var(--ink);
    }
    .btnrow{display:grid; gap:12px; margin-top:16px;}
    .subrow{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;}
    .tiny{
      text-align:center;
      font-size:16px;
      color:var(--muted);
      margin-top:14px;
      font-weight:700;
    }
    .error{
      margin-top:10px;
      padding:12px 14px;
      border-radius:14px;
      background:#fff1f2;
      border:1px solid #fecdd3;
      color:#9f1239;
      font-weight:800;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">Aktuell</div>

    <div class="card" id="card">
      <div class="cap"></div>
      <div class="inner">
        <h1>Wördle - Lina vs. Papa</h1>

        <div class="stats">
          <div class="label">Lina - Summe</div><div class="val" id="lSum">-</div>
          <div class="label">Papa - Summe</div><div class="val" id="pSum">-</div>
          <div class="label">Lina - Ø</div><div class="val" id="lAvg">-</div>
          <div class="label">Papa - Ø</div><div class="val" id="pAvg">-</div>
        </div>

        <div class="leader" id="leader">Aktuell vorne: -</div>

        <h2>Letzte 15 Einträge</h2>
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th class="num">Lina</th>
              <th class="num">Papa</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="3" style="color:#6b7280;font-weight:800;">Lade …</td></tr>
          </tbody>
        </table>

        <div class="btnrow">
          <a class="btn primary" id="btnForm" href="#" target="_blank" rel="noopener">+ Ergebnis eintragen</a>
          <button class="btn secondary" id="btnPlay" type="button">Wördle spielen</button>
          <button class="btn secondary" id="btnRefresh" type="button">Aktualisieren</button>
        </div>

        <div class="tiny" id="foot">Hinweis: Google “Veröffentlichen im Web” kann neue Form-Einträge 30–120 Sekunden verzögert in der CSV zeigen.</div>
        <div class="error" id="err"></div>
      </div>
    </div>
  </div>

<script>
/* ========= HIER NUR LINKS EINTRAGEN ========= */
const CSV_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSEjpKNfGDzEfrYw0QicDiJsj7KZwH_IDjaVVGhK_PpE5X-JvfwaPfXJYAkecOS21WMjeCRwBzWqiEB/pub?gid=1396043929&single=true&output=csv";
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScaYkNl3Pw8i6HFT6vSQ8sBioqNHiuN87ha8wQp08rvTdk-ng/viewform?usp=dialog";
const WORDLE_URL = "https://www.xn--wrdle-jua.de/";
/* =========================================== */

const $ = (id) => document.getElementById(id);

$("btnForm").href = FORM_URL;
$("btnPlay").addEventListener("click", () => window.open(WORDLE_URL, "_blank", "noopener"));
$("btnRefresh").addEventListener("click", () => loadAll(true));

function showError(msg){
  const el = $("err");
  el.style.display = "block";
  el.textContent = msg;
}
function clearError(){
  const el = $("err");
  el.style.display = "none";
  el.textContent = "";
}

function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;
  for (let i=0; i<text.length; i++){
    const c = text[i];
    if (c === '"'){
      if (inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes){
      row.push(cur); cur = "";
    } else if ((c === '\n' || c === '\r') && !inQuotes){
      if (c === '\r' && text[i+1] === '\n') i++;
      row.push(cur); cur = "";
      rows.push(row); row = [];
    } else {
      cur += c;
    }
  }
  row.push(cur);
  rows.push(row);
  return rows.filter(r => r.some(x => (x||"").trim() !== ""));
}

function lower(s){ return (s||"").toString().trim().toLowerCase(); }

function normalizeScore(v){
  // Wordle/Wördle: gültige Werte sind normalerweise 1-6
  const n = toNumber(v);
  if (n == null) return null;
  const i = Math.round(n);
  if (!Number.isFinite(i)) return null;
  if (i < 1 || i > 6) return null;
  return i;
}

// Unterstützt 2 CSV-Formate:
// 1) "wide"  : Spalten = Datum | Lina | Papa (direkt je Tag)
// 2) "long"  : Spalten = Datum | Name/Spieler | Versuche/Score
function detectFormat(header){
  const h = header.map(lower);

  const pickExact = (cands) => {
    for (const c of cands){
      const idx = h.findIndex(x => x === c);
      if (idx !== -1) return idx;
    }
    return -1;
  };

  // Datum (vom Spiel) – nicht Zeitstempel/Stand
  let dateIdx = pickExact(["datum des wördle","datum des wördl","datum","date"]);
  if (dateIdx === -1) dateIdx = h.findIndex(x => x.includes("datum") && !x.includes("zeit") && !x.includes("stand"));

  // Zeitstempel optional
  let tsIdx = pickExact(["zeitstempel","timestamp"]);
  if (tsIdx === -1) tsIdx = h.findIndex(x => x.includes("zeit") || x.includes("time"));

  // Spieler-Spalten (wide): wir wollen die *Tageswerte* und NICHT "Summe/Ø/Durchschnitt/Stand"
  const banned = ["summe","ø","durchschnitt","avg","mittel","stand","gesamt","total"];
  const isBanned = (s) => banned.some(b => s.includes(b));

  const pickPlayerCol = (name) => {
    // 1) exakt "lina"/"papa"
    let idx = h.findIndex(x => x === name);
    if (idx !== -1) return idx;

    // 2) "lina" enthalten, aber ohne banned
    const candidates = [];
    for (let i=0;i<h.length;i++){
      const x = h[i];
      if (x.includes(name) && !isBanned(x)) candidates.push(i);
    }
    if (candidates.length === 1) return candidates[0];

    // 3) bevorzugt Header, die nach "ergebnis"/"versuche"/"punkte" aussehen
    const prefer = ["ergebnis","versuch","versuche","punkte","score"];
    for (const key of prefer){
      const j = candidates.find(i => h[i].includes(key));
      if (j != null) return j;
    }

    // 4) fallback: erster "lina"/"papa" (auch wenn nicht perfekt)
    idx = h.findIndex(x => x.includes(name));
    return idx;
  };

  const linaIdx = pickPlayerCol("lina");
  const papaIdx = pickPlayerCol("papa");

  if (dateIdx >= 0 && linaIdx >= 0 && papaIdx >= 0){
    return {mode:"wide", dateIdx, linaIdx, papaIdx, tsIdx};
  }

  // Long-Format: Datum | Spieler/Name | Versuche/Score
  let whoIdx = pickExact(["name des spieler","name des spielers","spieler","name"]);
  if (whoIdx === -1) whoIdx = h.findIndex(x => x.includes("spieler") || x.includes("name"));

  let scoreIdx = pickExact(["wie viele versuch","wie viele versuche","versuche?","versuche","score","ergebnis"]);
  if (scoreIdx === -1) scoreIdx = h.findIndex(x =>
      (x.includes("versuch") && !x.includes("versuche num")) ||
      x.includes("score") || x.includes("ergebnis") || x.includes("punkte")
  );
  if (scoreIdx === -1) scoreIdx = h.findIndex(x => x.includes("versuche"));

  return {mode:"long", dateIdx, scoreIdx, whoIdx, tsIdx};
}
// (detectColumns wurde durch detectFormat ersetzt)

function toNumber(s){
  const t = (s||"").toString().trim();
  if (!t) return null;
  // akzeptiert "5", "5,0", "5.0"
  const norm = t.replace(",", ".");
  const n = Number(norm);
  return Number.isFinite(n) ? n : null;
}

// Pivot: eine Zeile pro Datum, Spalten Lina/Papa
function buildByDate(rows, cols){
  const map = new Map(); // date -> {lina, papa, tsMax}

  if (cols.mode === "wide"){
    for (const r of rows){
      const date = (r[cols.dateIdx] ?? "").toString().trim();
      if (!date) continue;
      const lina = normalizeScore(r[cols.linaIdx]);
      const papa = normalizeScore(r[cols.papaIdx]);
      const ts = cols.tsIdx >= 0 ? (r[cols.tsIdx] ?? "") : "";

      if (!map.has(date)) map.set(date, {date, lina:null, papa:null, tsMax:""});
      const obj = map.get(date);

      // Wenn es mehrere Zeilen pro Datum gibt: nimm die letzte (per Zeitstempel)
      const isNewer = !obj.tsMax || (ts && ts > obj.tsMax);
      if (isNewer){
        obj.lina = lina;
        obj.papa = papa;
        obj.tsMax = ts || obj.tsMax;
      } else {
        // falls kein Zeitstempel: fehlende Werte auffüllen
        if (obj.lina == null && lina != null) obj.lina = lina;
        if (obj.papa == null && papa != null) obj.papa = papa;
      }
    }
    return Array.from(map.values());
  }

  // Long-Format (Datum + Spielername + Score)
  for (const r of rows){
    const whoRaw = r[cols.whoIdx] ?? "";
    const who = lower(whoRaw);
    const date = (r[cols.dateIdx] ?? "").toString().trim();
    const score = normalizeScore(r[cols.scoreIdx]);
    if (!date || score == null) continue;

    const ts = cols.tsIdx >= 0 ? (r[cols.tsIdx] ?? "") : "";

    if (!map.has(date)) map.set(date, {date, lina:null, papa:null, tsMax:""});
    const obj = map.get(date);

    if (who.includes("lina")) obj.lina = score;
    if (who.includes("papa")) obj.papa = score;

    if (ts && ts > obj.tsMax) obj.tsMax = ts;
  }
  return Array.from(map.values());
}

function fmt(n){
  if (n == null) return "-";
  const s = (Math.round(n*10)/10).toFixed(1);
  return s.endsWith(".0") ? s.slice(0,-2) : s;
}

function computeStats(items){
  const lina = items.map(x => x.lina).filter(v => v!=null);
  const papa = items.map(x => x.papa).filter(v => v!=null);

  const sum = (arr) => arr.reduce((a,b)=>a+b,0);
  const avg = (arr) => arr.length ? sum(arr)/arr.length : null;

  const linaSum = lina.length ? sum(lina) : null;
  const papaSum = papa.length ? sum(papa) : null;
  const linaAvg = avg(lina);
  const papaAvg = avg(papa);

  return {linaSum, papaSum, linaAvg, papaAvg, linaCount:lina.length, papaCount:papa.length};
}

// Entscheidung: "real" = geringere Summe (bei gleicher Anzahl Spiele). Wenn unterschiedlich, nutzen Ø.
function decideLeader(stats){
  const bothHave = (stats.linaSum!=null && stats.papaSum!=null);
  if (!bothHave) return "-";

  if (stats.linaCount === stats.papaCount){
    if (stats.linaSum < stats.papaSum) return "Lina führt";
    if (stats.papaSum < stats.linaSum) return "Papa führt";
    return "Gleichstand";
  } else {
    if (stats.linaAvg < stats.papaAvg) return "Lina führt";
    if (stats.papaAvg < stats.linaAvg) return "Papa führt";
    return "Gleichstand";
  }
}

function render(items, stats){
  $("lSum").textContent = fmt(stats.linaSum);
  $("pSum").textContent = fmt(stats.papaSum);
  $("lAvg").textContent = fmt(stats.linaAvg);
  $("pAvg").textContent = fmt(stats.papaAvg);
  $("leader").textContent = "Aktuell vorne: " + decideLeader(stats);

  // sort latest first (Datum dd.mm.yyyy)
  const parseDate = (d) => {
    const m = /^\s*(\d{1,2})\.(\d{1,2})\.(\d{4})\s*$/.exec(d||"");
    if (!m) return 0;
    const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
    return yy*10000 + mm*100 + dd;
  };
  const sorted = [...items].sort((a,b) => (parseDate(b.date)-parseDate(a.date)) || (String(b.tsMax).localeCompare(String(a.tsMax))));

  const last15 = sorted.slice(0,15);
  const tbody = $("rows");
  tbody.innerHTML = "";

  if (!last15.length){
    tbody.innerHTML = '<tr><td colspan="3" style="color:#6b7280;font-weight:800;">Keine Daten gefunden.</td></tr>';
    return;
  }

  for (const x of last15){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${x.date}</td>
      <td class="num">${fmt(x.lina)}</td>
      <td class="num">${fmt(x.papa)}</td>
    `;
    tbody.appendChild(tr);
  }
}

async function loadAll(force){
  clearError();
  $("rows").innerHTML = '<tr><td colspan="3" style="color:#6b7280;font-weight:800;">Lade …</td></tr>';
  try{
    // Cache-Bust, damit GitHub Pages & Browser sicher neu ziehen
    const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error("CSV konnte nicht geladen werden. HTTP " + res.status);
    const text = await res.text();
    const table = parseCSV(text);

    if (!table.length) throw new Error("CSV ist leer.");

    const header = table[0];
    const rows = table.slice(1);

    const cols = detectFormat(header);

    if (cols.dateIdx < 0 || (cols.mode === "wide" && (cols.linaIdx < 0 || cols.papaIdx < 0)) || (cols.mode === "long" && (cols.whoIdx < 0 || cols.scoreIdx < 0))){
      throw new Error(
        "Spalten wurden nicht erkannt.\n" +
        "Gefunden: " + JSON.stringify(header) + "\n\n" +
        "Bitte Header prüfen: (a) Datum / Lina / Papa oder (b) Datum / Spieler / Versuche."
      );
    }

    const items = buildByDate(rows, cols);
    const stats = computeStats(items);
    render(items, stats);

    $("foot").textContent = "Stand: " + new Date().toLocaleString("de-DE") +
      " - Hinweis: neue Form-Einträge können in der veröffentlichten CSV etwas verzögert erscheinen.";
  } catch(e){
    showError(String(e && e.message ? e.message : e));
  }
}

loadAll(false);
</script>

<script>
  if (typeof csvUrl !== "undefined") {
    const link = document.getElementById("csvLink");
    if (link) link.href = csvUrl;
  }
</script>

</body>
</html>
